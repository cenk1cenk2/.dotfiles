#!/usr/bin/env bash

case "$1" in
"sound")
  shift

  set -e
  case "$1" in
  "help")
    echo "$(
      cat <<EOF
$0

Set default audio using wireplumber.
Usage: $0 sound [media.class] [alsa.card_name|media.name]
Example: $0 sound 'Audio/Sink' 'Scarlett 8i6 USB'

List available devices and their classes.
Usage: $0 sound ls
EOF
    )"
    ;;
  "ls")
    echo "Available sources are listed below."

    echo 'media.class,alsa.card_name,media.name'
    echo '-------------------------------------'

    pw-dump | jq -r '.[] | select(.type == "PipeWire:Interface:Node") | [ .info.props["media.class"], .info.props["alsa.card_name"], .info.props["media.name"]] | @csv'
    ;;
  *)
    # to inspect current
    # pw-dump | jq --arg media_class "Audio/Sink" --arg card_name "Scarlett 8i6 USB" '.[] | select(.type == "PipeWire:Interface:Node")' | b -l json
    wpctl set-default $(pw-dump | jq --arg media_class "$1" --arg card_name "$2" '.[] | select(.type == "PipeWire:Interface:Node" and ([.info.props["alsa.card_name"], .info.props["media.name"]] | index($card_name) > -1) and .info.props["media.class"] == $media_class) | .id')
    notify-send "wireplumber [$1]" "$2" -i /usr/share/icons/Adwaita/scalable/devices/audio-headphones.svg
    ;;
  esac
  ;;
"display")
  shift

  set -e

  case "$1" in
  "help")
    echo "$(
      cat <<EOF
$0

List available profiles.
Usage: $0 display ls

Reload the configuration.
Usage: $0 display reload

Apply a profile.
Usage: $0 display [profile]
EOF
    )"
    ;;
  "reload")
    kanshictl reload
    ;;
  "ls")
    cat "$HOME/.config/kanshi/config" | grep -E '^profile ' | awk '{print $2}' | uniq
    ;;
  *)
    /etc/udev/scripts/wayland-user.sh kanshictl switch "$1" && notify-send "display" "Trigger profile $1." -i /usr/share/icons/Adwaita/scalable/devices/video-display.svg
    ;;
  esac
  ;;
*)
  echo "Usage: $0 [sound|display]"
  ;;
esac
